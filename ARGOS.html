<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Argos — Architecture Repository for Governance &amp; Operational Standards</title>
  <style>
    :root {
      --bg-base:#f4f4f8;
      --bg-panel:#ffffff;
      --bg-dark:#04070f;
      --text-dark:#1c1c26;
      --text-light:#eef2ff;
      --text-muted:#5c6375;
      --brand:#3dd1c8;
      --border:#d4d9ea;
      --panel-shadow:0 20px 45px rgba(15, 23, 42, 0.15);
    }

    * { box-sizing:border-box; }

    body {
      margin:0;
      min-height:100vh;
      font-family:"Space Grotesk", "Inter", system-ui, sans-serif;
      background:var(--bg-base);
      color:var(--text-dark);
      display:flex;
      flex-direction:column;
    }

    body.theme-dark {
      background:#050914;
      color:var(--text-light);
    }

    .app-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:5;
      padding:0.75rem 1.25rem;
      background:rgba(255,255,255,0.92);
      border-bottom:1px solid var(--border);
      backdrop-filter:blur(12px);
    }

    body.theme-dark .app-header {
      background:rgba(3, 7, 17, 0.95);
      border-color:rgba(255,255,255,0.08);
    }

    .app-logo {
      display:flex;
      align-items:center;
      gap:0.5rem;
      font-weight:600;
    }

    .app-logo span {
      color:var(--brand);
      text-transform:uppercase;
      letter-spacing:0.1em;
    }

    .header-actions {
      display:flex;
      align-items:center;
      gap:0.5rem;
    }

    .icon-button,
    .action-button {
      border:0;
      border-radius:999px;
      padding:0.5rem 0.95rem;
      font-weight:600;
      cursor:pointer;
      background:var(--brand);
      color:#021118;
      transition:transform 0.2s ease;
    }

    .icon-button span {
      display:block;
      width:20px;
      height:2px;
      background:#021118;
      margin:4px 0;
      border-radius:2px;
    }

    .mode-toggle {
      background:transparent;
      border:1px solid rgba(0,0,0,0.1);
      color:var(--text-dark);
    }

    body.theme-dark .mode-toggle {
      border-color:rgba(255,255,255,0.4);
      color:var(--text-light);
    }

    main.grid-workspace {
      flex:1;
      position:relative;
      display:flex;
      width:100%;
      overflow:hidden;
    }

    .mode-panel {
      flex:1;
      padding:1.25rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
    }

    .grid-canvas {
      flex:1;
      background:var(--bg-panel);
      border-radius:18px;
      box-shadow:var(--panel-shadow);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }

    body.theme-dark .grid-canvas {
      background:#0c1420;
      box-shadow:0 25px 50px rgba(0,0,0,0.4);
    }

    .grid-wrapper {
      flex:1;
      overflow:auto;
      padding:0.5rem;
      min-height:0;
    }

    .grid-wrapper table {
      width:100%;
      height:100%;
      border-collapse:collapse;
    }

    .grid-wrapper th,
    .grid-wrapper td {
      border:1px solid rgba(0,0,0,0.05);
      min-width:140px;
      height:100px;
      padding:0.5rem;
      font-size:0.8rem;
      line-height:1.25;
      vertical-align:top;
      word-break:break-word;
      overflow:hidden;
      color:inherit;
    }

    body.theme-dark .grid-wrapper th,
    body.theme-dark .grid-wrapper td {
      color:#f7f8ff;
    }

    .grid-wrapper th {
      text-transform:uppercase;
      font-size:0.7rem;
      letter-spacing:0.08em;
    }

    .domain-label {
      font-weight:700;
    }

    .cell-content {
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      flex-direction:column;
      gap:0.35rem;
    }

    .cell-label {
      font-size:0.75rem;
    }

    .grid-wrapper.hide-labels .cell-label {
      opacity:0;
    }

    .overlay-drawer {
      position:absolute;
      top:0;
      right:0;
      width:320px;
      height:100%;
      background:var(--bg-panel);
      border-left:1px solid rgba(0,0,0,0.08);
      box-shadow:-10px 15px 40px rgba(0,0,0,0.25);
      transform:translateX(100%);
      transition:transform 0.25s ease;
      padding:1.25rem;
      display:flex;
      flex-direction:column;
      gap:1rem;
      z-index:4;
    }

    body.theme-dark .overlay-drawer {
      background:#0c1420;
      border-color:rgba(255,255,255,0.08);
      box-shadow:-10px 15px 40px rgba(0,0,0,0.8);
    }

    body.menu-open .overlay-drawer {
      transform:translateX(0);
    }

    .drawer-header h2 {
      margin:0;
      font-size:1.1rem;
    }

    .drawer-controls {
      display:flex;
      gap:0.5rem;
      flex-wrap:wrap;
    }

    .drawer-controls button {
      flex:1;
      font-size:0.75rem;
      padding:0.45rem 0.7rem;
      border-radius:8px;
      background:rgba(255,255,255,0.1);
      color:inherit;
      border:1px solid rgba(255,255,255,0.1);
    }

    body.theme-dark .drawer-controls button {
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.2);
    }

    .overlay-list {
      flex:1;
      overflow:auto;
      display:flex;
      flex-direction:column;
      gap:0.75rem;
    }

    .overlay-card {
      border:1px solid rgba(0,0,0,0.1);
      border-radius:12px;
      padding:0.75rem;
      background:rgba(255,255,255,0.9);
      display:flex;
      flex-direction:column;
      gap:0.2rem;
    }

    body.theme-dark .overlay-card {
      background:rgba(255,255,255,0.04);
      border-color:rgba(255,255,255,0.15);
    }

    .overlay-card strong {
      font-size:0.95rem;
    }

    .overlay-card p {
      margin:0;
      font-size:0.8rem;
      color:var(--text-muted);
    }

    .overlay-card small {
      color:var(--brand);
    }

    .overlay-card button {
      align-self:flex-start;
      margin-top:0.35rem;
      background:rgba(0,0,0,0.05);
      border:0;
      border-radius:8px;
      padding:0.35rem 0.8rem;
      cursor:pointer;
      font-weight:600;
    }

    .editor-panel {
      display:none;
      background:rgba(255,255,255,0.9);
      border-radius:18px;
      box-shadow:var(--panel-shadow);
      padding:1.25rem;
    }

    body.theme-dark .editor-panel {
      background:rgba(7,12,22,0.9);
    }

    .editor-panel.active {
      display:flex;
    }

    .editor-panel h3 {
      margin:0;
    }

    .editor-panel textarea {
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      padding:0.75rem;
      font-family:inherit;
      resize:vertical;
    }

    .editor-actions {
      display:flex;
      gap:0.5rem;
    }

    .modal {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:1.5rem;
      z-index:10;
    }

    .modal.visible {
      display:flex;
    }

    .modal-card {
      background:var(--bg-panel);
      border-radius:16px;
      width:100%;
      max-width:480px;
      padding:1.5rem;
      box-shadow:var(--panel-shadow);
      display:flex;
      flex-direction:column;
      gap:1rem;
    }

    body.theme-dark .modal-card {
      background:#0c1420;
      color:var(--text-light);
    }

    .modal-card input,
    .modal-card textarea {
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      padding:0.55rem 0.75rem;
      font-family:inherit;
    }

    .modal-actions {
      display:flex;
      justify-content:flex-end;
      gap:0.5rem;
    }

    .modal-actions button {
      border-radius:999px;
      border:0;
      padding:0.5rem 1rem;
      cursor:pointer;
      font-weight:600;
    }

    .modal-close {
      background:rgba(255,255,255,0.1);
    }

    @media (max-width:900px) {
      .overlay-drawer {
        width:100%;
      }

      main.grid-workspace {
        flex-direction:column;
      }
    }
  </style>
</head>
<body class="theme-light" data-mode="viewer">
  <header class="app-header">
    <button class="icon-button" id="menuToggle" aria-label="Open overlays menu">
      <span></span>
      <span></span>
      <span></span>
    </button>
    <div class="app-logo">
      <span>Argos</span>
      <span>Architecture Repository</span>
    </div>
    <div class="header-actions">
      <button class="mode-toggle" id="modeToggle">Viewer Mode</button>
      <button class="action-button" id="themeToggle">Dark Theme</button>
    </div>
  </header>

  <main class="grid-workspace">
    <section class="mode-panel viewer-panel" data-mode-panel="viewer">
      <div class="grid-canvas">
        <div class="grid-wrapper" id="gridWrapper">
          <table id="gridMount"></table>
        </div>
      </div>
    </section>

    <section class="mode-panel editor-panel" data-mode-panel="editor">
      <div>
        <h3>Editor Mode</h3>
        <p>Select viewpoints by name to create a new overlay. Use the drawer to manage overlays once saved.</p>
        <p style="color:var(--text-muted);font-size:0.85rem;">Enter label text exactly as shown in the grid (new line separated).</p>
      </div>
      <textarea id="editorTextarea" rows="4" placeholder="Enter viewpoint labels here"></textarea>
      <div class="editor-actions">
        <button class="action-button" id="createCustomOverlay">Create Custom Overlay</button>
      </div>
    </section>

    <aside class="overlay-drawer" id="overlayDrawer">
      <div class="drawer-header">
        <h2>Layers</h2>
        <p style="margin:0;font-size:0.8rem;color:var(--text-muted);">Drag order affects merged overlays, visibility filters what renders.</p>
      </div>
      <div class="drawer-controls">
        <button id="importButton">Import</button>
        <button id="exportButton">Export</button>
        <button id="clearStorage">Clear</button>
      </div>
      <div class="drawer-controls">
        <button id="hideAllButton">Hide Labels</button>
        <input type="search" id="overlaySearch" placeholder="Search overlays" style="flex:1;border-radius:12px;border:1px solid var(--border);padding:0.4rem 0.9rem;" />
      </div>
      <div class="overlay-list" id="overlayList"></div>
      <input type="file" accept="application/json" id="importInput" style="display:none" />
    </aside>
  </main>

  <div class="modal" id="overlayModal" aria-hidden="true">
    <div class="modal-card">
      <h3>Create Overlay</h3>
      <form id="createOverlayForm">
        <input type="text" id="overlayName" placeholder="Overlay name" required />
        <textarea id="overlayDescription" rows="2" placeholder="Optional description"></textarea>
        <textarea id="overlayCells" rows="4" placeholder="Comma-separated labels"></textarea>
        <div class="modal-actions">
          <button type="button" class="modal-close" id="modalCancel">Cancel</button>
          <button type="submit" class="action-button">Create overlay</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (() => {
      const labelCSV = `Domain (Y-Axis)\\Model Kinds (X-Axis),Motivation (Mv),Taxonomy (Tx),Structure (Sr),Connectivity (Cn),Processes (Pr),States (St),Sequences (Sq),Information (If),Parameters (Pm),Constraints (Ct),Roadmap (Rm),Traceability (Tr)
Architecture Management (Am),Architecture Principles (Am-Mv),Architecture Extensions (Am-Tx),Architecture Views (Am-Sr),Architecture References (Am-Cn),Architecture Development Method (Am-Pr),Architecture Status (Am-St),<EMPTY>,Dictionary (Am-If),Architecture Parameters (Am-Pm),Architecture Constraints (Am-Ct),Architecture Roadmap (Am-Rm),Architecture Traceability (Am-Tr)
Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov),Summary & Overview (Sm-Ov)
Strategic (St),Strategic Motivation (St-Mv),Strategic Taxonomy (St-Tx),Strategic Structure (St-Sr),Strategic Connectivity (St-Cn),Strategic Processes (St-Pr),Strategic States (St-St),<EMPTY>,Strategic Information (St-If),Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),Strategic Constraints (St-Ct),Strategic Deployment / Strategic Phasing (St-Rm-D / St-Rm-P),Strategic Traceability (St-Tr)
Operational (Op),Requirements (Rq-Mv),Operational Taxonomy (Op-Tx),Operational Structure (Op-Sr),Operational Connectivity (Op-Cn),Operational Processes (Op-Pr),Operational States (Op-St),Operational Sequences (Op-Sq),Operational Information (Op-If),Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),Operational Constraints (Op-Ct),<EMPTY>,Operational Traceability (Op-Tr)
Services  (Sv),Requirements (Rq-Mv),Services Taxonomy (Sv-Tx),Services Structure (Sv-Sr),Services Connectivity (Sv-Cn),Services Processes (Sv-Pr),Services States (Sv-St),Services Sequences (Sv-Sq),Operational Information (Op-If),Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),Services Constraints (Sv-Ct),Services Roadmap (Sv-Rm),Services Traceability (Sv-Tr)
Personnel (Ps),Requirements (Rq-Mv),Personnel Taxonomy (Ps-Tx),Personnel Structure (Ps-Sr),Personnel Connectivity (Ps-Cn),Personnel Processes (Ps-Pr),Personnel States (Ps-St),Personnel Sequences (Ps-Sq),Resources Information (Rs-If),Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),Competence / Drivers / Performance (Ps-Ct),Personnel Availability / Personnel Evolution / Personnel Forecast (Ps-Rm-A / Ps-Rm-E / Ps-Rm-F),Personnel Traceability (Ps-Tr)
Resources (Rs),Requirements (Rq-Mv),Resources Taxonomy (Rs-Tx),Resources Structure (Rs-Sr),Resources Connectivity (Rs-Cn),Resources Processes (Rs-Pr),Resources States (Rs-St),Resources Sequences (Rs-Sq),Resources Information (Rs-If),Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),Resources Constraints (Rs-Ct),Resources Evolution / Forecast (Rs-Rm-E / Rs-Rm-F),Resources Traceability (Rs-Tr)
Security (Sc),Security Controls (Sc-Mv),Security Taxonomy (Sc-Tx),Security Structure (Sc-Sr),Security Connectivity (Sc-Cn),Security Processes (Sc-Pr),<EMPTY>,<EMPTY>,Resources Information (Rs-If),Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),Security Constraints (Sc-Ct),<EMPTY>,Security Traceability (Sc-Tr)
Projects (Pj),<EMPTY>,Projects Taxonomy (Pj-Tx),Projects Structure (Pj-Sr),Projects Connectivity (Pj-Cn),Projects Processes (Pj-Pr),<EMPTY>,<EMPTY>,<EMPTY>,Environment / Measurements / Risks (En-Pm-E / Me-Pm-M / Rk-Pm-R),<EMPTY>,Projects Roadmap (Pj-Rm),Projects Traceability (Pj-Tr)
Standards (Sd),<EMPTY>,Standards Taxonomy (Sd-Tx),Standards Structure (Sd-Sr),<EMPTY>,<EMPTY>,<EMPTY>,<EMPTY>,<EMPTY>,<EMPTY>,<EMPTY>,Standards Roadmap (Sd-Rm),Standards Traceability (Sd-Tr)
Actual Resources (Ar),<EMPTY>,<EMPTY>,Actual Resources Structure (Ar-Sr),Actual Resources Connectivity (Ar-Cn),Simulation,Simulation,Simulation,<EMPTY>,<EMPTY>,Parametric Execution/Evaluation,<EMPTY>,<EMPTY>`;

      const colorCSV = `#FFFFFF\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000
#FFFFCC\t#FFFFCC\t#FFFFCC\t#FFFFCC\t#FFFFCC\t#FFFFCC\t#FFFFCC\t#000000\t#FFFFCC\t#FFFFCC\t#FFFFCC\t#FFFFCC\t#FFFFCC
#595959\t#595959\t#595959\t#595959\t#595959\t#595959\t#595959\t#595959\t#595959\t#0070C0\t#595959\t#595959\t#595959
#D7E4BD\t#D7E4BD\t#D7E4BD\t#D7E4BD\t#D7E4BD\t#D7E4BD\t#D7E4BD\t#000000\t#D7E4BD\t#0070C0\t#D7E4BD\t#D7E4BD\t#D7E4BD
#8EB4E3\t#7F7F7F\t#8EB4E3\t#8EB4E3\t#8EB4E3\t#8EB4E3\t#8EB4E3\t#8EB4E3\t#BFBFBF\t#0070C0\t#8EB4E3\t#000000\t#8EB4E3
#E6B9B8\t#7F7F7F\t#E6B9B8\t#E6B9B8\t#E6B9B8\t#E6B9B8\t#E6B9B8\t#E6B9B8\t#BFBFBF\t#0070C0\t#E6B9B8\t#E6B9B8\t#E6B9B8
#FFFFFF\t#7F7F7F\t#FFFFFF\t#FFFFFF\t#FFFFFF\t#FFFFFF\t#FFFFFF\t#FFFFFF\t#BFBFBF\t#0070C0\t#FFFFFF\t#FFFFFF\t#FFFFFF
#FCD5B5\t#7F7F7F\t#FCD5B5\t#FCD5B5\t#FCD5B5\t#FCD5B5\t#FCD5B5\t#FCD5B5\t#BFBFBF\t#0070C0\t#FCD5B5\t#FCD5B5\t#FCD5B5
#B7DEE8\t#B7DEE8\t#B7DEE8\t#B7DEE8\t#B7DEE8\t#B7DEE8\t#000000\t#000000\t#BFBFBF\t#0070C0\t#B7DEE8\t#000000\t#B7DEE8
#CCC1DA\t#000000\t#CCC1DA\t#CCC1DA\t#CCC1DA\t#CCC1DA\t#000000\t#000000\t#000000\t#0070C0\t#000000\t#CCC1DA\t#CCC1DA
#C4BD97\t#000000\t#C4BD97\t#C4BD97\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#000000\t#C4BD97\t#C4BD97
#595959\t#000000\t#000000\t#595959\t#595959\t#595959\t#595959\t#595959\t#000000\t#000000\t#595959\t#000000\t#000000`;

      const STORAGE_KEY = 'argos:state';
      const menuToggle = document.getElementById('menuToggle');
      const overlayDrawer = document.getElementById('overlayDrawer');
      const gridMount = document.getElementById('gridMount');
      const gridWrapper = document.getElementById('gridWrapper');
      const overlayList = document.getElementById('overlayList');
      const hideAllButton = document.getElementById('hideAllButton');
      const overlaySearch = document.getElementById('overlaySearch');
      const themeToggle = document.getElementById('themeToggle');
      const modeToggle = document.getElementById('modeToggle');
      const viewerPanel = document.querySelector('[data-mode-panel="viewer"]');
      const editorPanel = document.querySelector('[data-mode-panel="editor"]');
      const createCustomOverlay = document.getElementById('createCustomOverlay');
      const overlayModal = document.getElementById('overlayModal');
      const modalCancel = document.getElementById('modalCancel');
      const overlayForm = document.getElementById('createOverlayForm');
      const overlayNameInput = document.getElementById('overlayName');
      const overlayDescriptionInput = document.getElementById('overlayDescription');
      const overlayCellsInput = document.getElementById('overlayCells');
      const importInput = document.getElementById('importInput');
      const importButton = document.getElementById('importButton');
      const exportButton = document.getElementById('exportButton');
      const clearStorageButton = document.getElementById('clearStorage');

      const defaultState = {
        overlays: [],
        layerOrder: [],
        mode: 'viewer',
        theme: 'light',
        hideAllOverlays: false,
        searchTerm: ''
      };

      let colorMatrix = [];
      let gridData;
      let labelLookup = new Map();
      const state = loadState();

      function parseLabels() {
        const rows = labelCSV.trim().split('\n').map(line => line.split(','));
        const headers = rows[0].slice(1).map(cell => cell.trim());
        const domains = rows.slice(1).map(row => ({
          domain: row[0].trim(),
          cells: row.slice(1).map(cell => {
            const text = cell.trim();
            return text === '<EMPTY>' ? '' : text;
          })
        }));
        return { headers, domains };
      }

      function parseColors() {
        return colorCSV.trim().split('\n').map(line => line.split(/\s+/).filter(Boolean));
      }

      function buildGridData() {
        const labels = parseLabels();
        colorMatrix = parseColors();
        const rows = labels.domains.map((row, rowIndex) => ({
          domain: row.domain,
          cells: row.cells.map((label, colIndex) => ({
            label,
            color: (colorMatrix[rowIndex + 1] && colorMatrix[rowIndex + 1][colIndex]) || '#000',
            rowIndex,
            colIndex
          }))
        }));
        gridData = { headers: labels.headers, rows };
        buildLookup();
      }

      function buildLookup() {
        labelLookup.clear();
        gridData.rows.forEach(row => {
          row.cells.forEach(cell => {
            if (!cell.label) return;
            const key = cell.label.toLowerCase();
            if (!labelLookup.has(key)) labelLookup.set(key, []);
            labelLookup.get(key).push({ rowIndex: cell.rowIndex, colIndex: cell.colIndex });
          });
        });
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && parsed.overlays) {
              return { ...defaultState, ...parsed };
            }
          }
        } catch (error) {
          console.warn('Unable to parse saved state', error);
        }
        return { ...defaultState };
      }

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function ensureDefaultOverlay() {
        if (!state.overlays.length) {
          const cells = [];
          gridData.rows.forEach(row => {
            row.cells.forEach(cell => {
              if (cell.label) cells.push({ rowIndex: cell.rowIndex, colIndex: cell.colIndex });
            });
          });
          const defaultOverlay = {
            id: 'default-uaf-view',
            name: 'UAF Standard View',
            description: 'All default viewpoints using the official grid data.',
            visible: true,
            cells,
            metadata: { base: true }
          };
          state.overlays.push(defaultOverlay);
        }
        if (!state.layerOrder.length) {
          state.layerOrder = state.overlays.map(overlay => overlay.id);
        }
      }

      function createCellNode(cell) {
        const td = document.createElement('td');
        td.dataset.row = cell.rowIndex;
        td.dataset.col = cell.colIndex;
        td.dataset.label = cell.label;
        td.style.background = cell.color;

        const content = document.createElement('div');
        content.className = 'cell-content';
        const label = document.createElement('span');
        label.className = 'cell-label';
        label.textContent = cell.label;
        content.appendChild(label);
        td.appendChild(content);
        return td;
      }

      function renderGrid() {
        gridMount.innerHTML = '';
        const table = gridMount;
        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        const corner = document.createElement('th');
        corner.className = 'domain-label';
        corner.textContent = '';
        headRow.appendChild(corner);
        const headerColors = colorMatrix[0] || [];

        gridData.headers.forEach((header, index) => {
          const th = document.createElement('th');
          th.textContent = header;
          const axisColor = headerColors[index];
          if (axisColor) {
            th.style.background = axisColor;
            th.style.color = axisColor.toUpperCase() === '#FFFFFF' ? '#1f2530' : '#fff';
          }
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        gridData.rows.forEach((row, rowIndex) => {
          const tr = document.createElement('tr');
          const domainCell = document.createElement('th');
          domainCell.textContent = row.domain;
          domainCell.className = 'domain-label';
          const domainColor = colorMatrix[rowIndex + 1] && colorMatrix[rowIndex + 1][0];
          if (domainColor) {
            domainCell.style.background = domainColor;
            domainCell.style.color = domainColor.toUpperCase() === '#FFFFFF' ? '#1f2530' : '#fff';
          }
          tr.appendChild(domainCell);
          row.cells.forEach(cell => tr.appendChild(createCellNode(cell)));
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        updateLabelVisibility();
      }

      function updateLabelVisibility() {
        gridWrapper.classList.toggle('hide-labels', state.hideAllOverlays);
        hideAllButton.textContent = state.hideAllOverlays ? 'Show Labels' : 'Hide Labels';
        saveState();
      }

      function renderOverlayList() {
        overlayList.innerHTML = '';
        const query = (state.searchTerm || '').toLowerCase();
        const ordered = state.layerOrder
          .map(id => state.overlays.find(overlay => overlay.id === id))
          .filter(Boolean);
        const filtered = ordered.filter(overlay => `${overlay.name} ${overlay.description || ''}`.toLowerCase().includes(query));
        if (!filtered.length) {
          const empty = document.createElement('p');
          empty.textContent = 'No overlays match search. Create one in Editor mode.';
          empty.className = 'helper-text';
          overlayList.appendChild(empty);
          return;
        }
        filtered.forEach(overlay => {
          const card = document.createElement('article');
          card.className = 'overlay-card';
          const title = document.createElement('strong');
          title.textContent = overlay.name;
          const description = document.createElement('p');
          description.textContent = overlay.description || 'No description yet.';
          const metadata = document.createElement('small');
          metadata.textContent = `${overlay.cells?.length || 0} viewpoints · ${overlay.visible ? 'Visible' : 'Hidden'}`;
          const toggle = document.createElement('button');
          toggle.textContent = overlay.visible ? 'Hide layer' : 'Show layer';
          toggle.addEventListener('click', () => {
            overlay.visible = !overlay.visible;
            saveState();
            renderOverlayList();
          });
          card.append(title, description, metadata, toggle);
          overlayList.appendChild(card);
        });
      }

      function swapMode() {
        state.mode = state.mode === 'viewer' ? 'editor' : 'viewer';
        viewerPanel.style.display = state.mode === 'viewer' ? 'block' : 'none';
        if (state.mode === 'editor') editorPanel.classList.add('active'); else editorPanel.classList.remove('active');
        modeToggle.textContent = state.mode === 'viewer' ? 'Viewer Mode' : 'Editor Mode';
        saveState();
      }

      function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        document.body.classList.toggle('theme-dark', state.theme === 'dark');
        document.body.classList.toggle('theme-light', state.theme === 'light');
        themeToggle.textContent = state.theme === 'dark' ? 'Light Theme' : 'Dark Theme';
        saveState();
      }

      function exportState() {
        const payload = JSON.stringify(state, null, 2);
        const blob = new Blob([payload], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const anchor = document.createElement('a');
        anchor.href = url;
        anchor.download = 'argos-state.json';
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(url);
      }

      function showModal() {
        overlayModal.classList.add('visible');
        overlayModal.setAttribute('aria-hidden', 'false');
      }

      function closeModal() {
        overlayModal.classList.remove('visible');
        overlayModal.setAttribute('aria-hidden', 'true');
      }

      function createOverlayFromForm(event) {
        event.preventDefault();
        const name = overlayNameInput.value.trim();
        if (!name) return;
        const description = overlayDescriptionInput.value.trim();
        const cellText = overlayCellsInput.value.trim();
        const labels = cellText
          .split(/[,\n;]+/)
          .map(part => part.trim())
          .filter(Boolean);
        const cells = [];
        labels.forEach(label => {
          const matches = labelLookup.get(label.toLowerCase());
          if (matches?.length) {
            cells.push(matches[0]);
          }
        });
        const overlay = {
          id: `custom-${Date.now()}`,
          name,
          description,
          visible: true,
          cells,
          metadata: { createdAt: new Date().toISOString() }
        };
        state.overlays.unshift(overlay);
        state.layerOrder.unshift(overlay.id);
        saveState();
        renderOverlayList();
        overlayForm.reset();
        closeModal();
      }

      function handleImport(event) {
        const file = event.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const parsed = JSON.parse(reader.result);
            if (!parsed || !Array.isArray(parsed.overlays)) throw new Error('Invalid Argos state');
            state.overlays = parsed.overlays;
            state.layerOrder = parsed.layerOrder || state.overlays.map(o => o.id);
            state.mode = parsed.mode || state.mode;
            state.theme = parsed.theme || state.theme;
            state.hideAllOverlays = !!parsed.hideAllOverlays;
            state.searchTerm = parsed.searchTerm || '';
            overlaySearch.value = state.searchTerm;
            saveState();
            renderOverlayList();
          } catch (error) {
            alert(error.message);
          }
        };
        reader.readAsText(file);
      }

      function clearStorage() {
        if (confirm('Clear all overlays and settings?')) {
          localStorage.removeItem(STORAGE_KEY);
          location.reload();
        }
      }

      function init() {
        buildGridData();
        ensureDefaultOverlay();
        saveState();
        renderGrid();
        renderOverlayList();
        viewerPanel.style.display = 'block';
        editorPanel.classList.remove('active');
        document.body.classList.toggle('theme-dark', state.theme === 'dark');
        document.body.classList.toggle('theme-light', state.theme === 'light');
        if (state.mode === 'editor') swapMode();
      }

      menuToggle.addEventListener('click', () => {
        document.body.classList.toggle('menu-open');
      });

      hideAllButton.addEventListener('click', () => {
        state.hideAllOverlays = !state.hideAllOverlays;
        updateLabelVisibility();
      });

      overlaySearch.addEventListener('input', event => {
        state.searchTerm = event.target.value;
        saveState();
        renderOverlayList();
      });

      themeToggle.addEventListener('click', toggleTheme);
      modeToggle.addEventListener('click', swapMode);
      createCustomOverlay.addEventListener('click', showModal);
      modalCancel.addEventListener('click', closeModal);
      overlayForm.addEventListener('submit', createOverlayFromForm);
      exportButton.addEventListener('click', exportState);
      importButton.addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', handleImport);
      clearStorageButton.addEventListener('click', clearStorage);

      init();
    })();
  </script>
</body>
</html>
